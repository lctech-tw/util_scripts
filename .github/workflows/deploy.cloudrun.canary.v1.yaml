name: deploy.cloudrun.canary.v1
on:
  workflow_call:
    inputs:
      ZMODE:
        description: "Mode"
        required: false
        type: string
        default: prod
      APP_DOCKER_REPOSITORIES:
        description: "Docker repositories name"
        required: true
        type: string
      APP_NAME:
        description: "App name"
        required: true
        type: string
      GCP_PROJECT:
        description: "GCP project"
        required: true
        type: string
      GCP_CLOUD_RUN_NAME:
        description: "GCP cloudrun name"
        required: true
        type: string
      GCP_CLOUD_RUN_REGION:
        description: "GCP cloudrun region"
        required: true
        type: string
      GCP_CLOUD_RUN_PORT:
        required: false
        type: string
        default: "8080"
      GCP_CLOUD_RUN_VPC:
        required: false
        type: string
      GCP_CLOUD_RUN_CPU:
        required: false
        type: string
        default: "1"
      GCP_CLOUD_RUN_MEM:
        required: false
        type: string
        default: "1Gi"
      GCP_CLOUD_RUN_CONFIG_FILE_PATH:
        required: false
        type: string
        default: ""
      CANARY_TRAFFIC_PERCENT:
        description: "Percentage of traffic to route to canary (0-100)"
        required: false
        type: string
        default: "10"
jobs:
  deploy-canary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: ‚öôÔ∏è Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{secrets.GCP_SA_KEY_GITHUB_CI}}

      - name: üöÄ Deploy Canary Revision
        run: |
          echo "@ Deploying canary: ${{inputs.GCP_PROJECT}} -> ${{inputs.GCP_CLOUD_RUN_NAME}} -> ${{inputs.ZMODE}}"
          REVISION_NAME="${{inputs.GCP_CLOUD_RUN_NAME}}-http-canary-${{github.run_number}}"

          if [ "${{inputs.GCP_CLOUD_RUN_CONFIG_FILE_PATH}}" != "" ]; then
            gcloud run deploy ${{inputs.GCP_CLOUD_RUN_NAME}}-http \
              --project ${{inputs.GCP_PROJECT}} \
              --region ${{inputs.GCP_CLOUD_RUN_REGION}} \
              --image "${{inputs.APP_DOCKER_REPOSITORIES}}/${{inputs.APP_NAME}}:${{inputs.ZMODE}}-${{github.run_number}}" \
              --cpu "${{inputs.GCP_CLOUD_RUN_CPU}}" \
              --memory "${{inputs.GCP_CLOUD_RUN_MEM}}" \
              --port "${{inputs.GCP_CLOUD_RUN_PORT}}" \
              --vpc-connector "${{inputs.GCP_CLOUD_RUN_VPC}}" \
              --env-vars-file ${{inputs.GCP_CLOUD_RUN_CONFIG_FILE_PATH}}/${{inputs.ZMODE}}.yaml \
              --revision-suffix "canary-${{github.run_number}}" \
              --no-traffic \
              --tag canary
          else
            gcloud run deploy ${{inputs.GCP_CLOUD_RUN_NAME}}-http \
              --project ${{inputs.GCP_PROJECT}} \
              --region ${{inputs.GCP_CLOUD_RUN_REGION}} \
              --image "${{inputs.APP_DOCKER_REPOSITORIES}}/${{inputs.APP_NAME}}:${{inputs.ZMODE}}-${{github.run_number}}" \
              --cpu "${{inputs.GCP_CLOUD_RUN_CPU}}" \
              --memory "${{inputs.GCP_CLOUD_RUN_MEM}}" \
              --port "${{inputs.GCP_CLOUD_RUN_PORT}}" \
              --vpc-connector "${{inputs.GCP_CLOUD_RUN_VPC}}" \
              --revision-suffix "canary-${{github.run_number}}" \
              --no-traffic \
              --tag canary
          fi

      - name: üîÄ Route Traffic to Canary
        run: |
          echo "@ Routing ${{inputs.CANARY_TRAFFIC_PERCENT}}% traffic to canary"
          STABLE_TRAFFIC=$((100 - ${{inputs.CANARY_TRAFFIC_PERCENT}}))

          gcloud run services update-traffic ${{inputs.GCP_CLOUD_RUN_NAME}}-http \
            --project ${{inputs.GCP_PROJECT}} \
            --region ${{inputs.GCP_CLOUD_RUN_REGION}} \
            --to-revisions LATEST=${{inputs.CANARY_TRAFFIC_PERCENT}} \
            --to-tags stable=${STABLE_TRAFFIC}

          echo "‚úÖ Canary deployment complete"
          echo "üîó Canary URL: https://canary---${{inputs.GCP_CLOUD_RUN_NAME}}-http-${{hashFiles('**')}}.${{inputs.GCP_CLOUD_RUN_REGION}}.run.app"

  promote-canary:
    runs-on: ubuntu-latest
    needs: deploy-canary
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: ‚öôÔ∏è Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{secrets.GCP_SA_KEY_GITHUB_CI}}

      - name: ‚úÖ Promote Canary to Stable
        run: |
          echo "@ Promoting canary to stable (100% traffic)"
          gcloud run services update-traffic ${{inputs.GCP_CLOUD_RUN_NAME}}-http \
            --project ${{inputs.GCP_PROJECT}} \
            --region ${{inputs.GCP_CLOUD_RUN_REGION}} \
            --to-latest

          gcloud run services update-traffic ${{inputs.GCP_CLOUD_RUN_NAME}}-http \
            --project ${{inputs.GCP_PROJECT}} \
            --region ${{inputs.GCP_CLOUD_RUN_REGION}} \
            --update-tags stable=LATEST

          echo "üéâ Canary promoted to stable"
